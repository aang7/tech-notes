<!DOCTYPE html>
<html lang="en">
<head>
<!-- Aug 02, 2023 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PostgreSQL</title>
<meta name="generator" content="Org mode">
<meta name="author" content="Abel Abner">
<link rel='stylesheet' href='https://cdn.simplecss.org/simple.min.css' />
   <link rel='stylesheet' type='text/css' href='../css/tech-notes-site.css' />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../"> UP </a>
 |
 <a accesskey="H" href="../"> HOME </a>
</div><nil id="nil">
<header>
<h1 class="title">PostgreSQL</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orga31b297">1. What is an schema</a></li>
<li><a href="#org7986bd0">2. Indexes</a></li>
<li><a href="#org52d6e94">3. Foreign keys</a></li>
<li><a href="#orge086dfc">4. Postgraphile Notes</a></li>
<li><a href="#orgcb98dc1">5. Data types</a></li>
<li><a href="#org0e3bb1f">6. Database design process</a></li>
<li><a href="#orgefa4f09">7. Notes from PostgreSQL official manual</a></li>
<li><a href="#orga6a9bcc">8. Common Table Expressions</a></li>
<li><a href="#org6c56e55">9. Recursive queries in SQL</a></li>
<li><a href="#org9558fae">10. Snippets Examples</a></li>
<li><a href="#orgcc9ec4a">11. Course notes</a>
<ul>
<li><a href="#org7137e0c">11.1. Migrations</a></li>
<li><a href="#org7f02386">11.2. Foreign keys</a></li>
</ul>
</li>
<li><a href="#org31f5bdb">12. Random notes</a></li>
</ul>
</div>
</nav>
<section id="outline-container-orga31b297" class="outline-2">
<h2 id="orga31b297"><span class="section-number-2">1</span> What is an schema</h2>
<div class="outline-text-2" id="text-1">
<p>
An schema is basically a logical segmentation that holds database objects like views, indexes, data types, functions, store procedures and operators.
<a href="https://www.postgresqltutorial.com/postgresql-administration/postgresql-schema/#:~:text=In%20PostgreSQL%2C%20a%20schema%20is,functions%2C%20stored%20procedures%20and%20operators.&amp;text=A%20database%20can%20contain%20one,belongs%20to%20only%20one%20database.">here is a good post</a> about this in detail.
</p>
</div>
</section>


<section id="outline-container-org7986bd0" class="outline-2">
<h2 id="org7986bd0"><span class="section-number-2">2</span> Indexes</h2>
<div class="outline-text-2" id="text-2">
<p>
B-Tree is the default that you get when you do CREATE INDEX. Virtually all databases have some B-tree indexes.
B-tree indexes are optimized for when a row has a single key value.
</p>
</div>
</section>

<section id="outline-container-org52d6e94" class="outline-2">
<h2 id="org52d6e94"><span class="section-number-2">3</span> Foreign keys</h2>
<div class="outline-text-2" id="text-3">
<p>
More about foreign keys:
</p>

<ul class="org-ul">
<li>postgres official <a href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK">page</a></li>
</ul>
</div>
</section>



<section id="outline-container-orge086dfc" class="outline-2">
<h2 id="orge086dfc"><span class="section-number-2">4</span> Postgraphile Notes</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>PostGraphile detects and exposes one-to-one, one-to-many and many-to-one relations automatically. Many-to-many relationships can be handled with the many-to-many relations plugin.</li>
<li><a href="https://www.graphile.org/postgraphile/relations/">https://www.graphile.org/postgraphile/relations/</a></li>
</ul>
</div>
</section>


<section id="outline-container-orgcb98dc1" class="outline-2">
<h2 id="orgcb98dc1"><span class="section-number-2">5</span> Data types</h2>
<div class="outline-text-2" id="text-5">
<p>
Check out this <b><a href="https://www.geeksforgeeks.org/postgresql-data-types/article">post.</a></b>
</p>

<p>
JSON data type stackoverflow overview <a href="https://stackoverflow.com/a/10560761">comment</a>.
</p>

<p>
raw JSON vs JSON Binary:
</p>

<p>
If you know before hand that you will not be performing JSON querying operations, then use the JSON data type. For all other cases, use JSONB. More <a href="http://www.silota.com/docs/recipes/sql-postgres-json-data-types.html">here</a>.
</p>
</div>
</section>


<section id="outline-container-org0e3bb1f" class="outline-2">
<h2 id="org0e3bb1f"><span class="section-number-2">6</span> Database design process</h2>
<div class="outline-text-2" id="text-6">
<ol class="org-ol">
<li>What kind of thing are we storing?</li>
<li>what properties does this thing have?</li>
<li>what type of data does each of those properties contain?</li>
</ol>
</div>
</section>

<section id="outline-container-orgefa4f09" class="outline-2">
<h2 id="orgefa4f09"><span class="section-number-2">7</span> Notes from PostgreSQL official manual</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Tables are grouped into databases, and a collection of databases managed by a single PostgreSQL server
instance constitutes a database cluster</li>
<li></li>
</ul>
</div>
</section>

<section id="outline-container-orga6a9bcc" class="outline-2">
<h2 id="orga6a9bcc"><span class="section-number-2">8</span> Common Table Expressions</h2>
<div class="outline-text-2" id="text-8">
<p>
Abbreviated as <b>CTE</b> is a one-time result set that only exists for the duration of the query. It allows us to refer to data within a single SELECT, INSERT, UPDATE, DELETE, CREATE VIEW, or MERGE statement's execution scope.
</p>
</div>
</section>

<section id="outline-container-org6c56e55" class="outline-2">
<h2 id="org6c56e55"><span class="section-number-2">9</span> Recursive queries in SQL</h2>
<div class="outline-text-2" id="text-9">
<p>
To write a recursive query in SQL we need to use a CTE.
The syntax is the following:
</p>


<figure>
<img src="notes.org_imgs/20230410_153812_UAEctx.png" alt="20230410_153812_UAEctx.png">

</figure>

<p>
So for instance if we like to print a sequence of numbers using this recursive approach we could write the following
sql:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">with</span> <span class="org-keyword">recursive</span> numbers <span class="org-keyword">AS</span> (
        <span class="org-keyword">select</span> 1 <span class="org-keyword">as</span> n
          <span class="org-keyword">union</span> <span class="org-keyword">all</span>
        <span class="org-keyword">select</span> n + 1 <span class="org-keyword">from</span> numbers <span class="org-keyword">where</span> n &lt; 5
)

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> numbers;
</pre>
</div>


<pre class="example">
n
1
2
3
4
5
</pre>
</div>
</section>

<section id="outline-container-org9558fae" class="outline-2">
<h2 id="org9558fae"><span class="section-number-2">10</span> Snippets Examples</h2>
<div class="outline-text-2" id="text-10">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Insert operation</label><pre class="src src-sql"><span class="org-keyword">insert</span> <span class="org-keyword">into</span> cities(<span class="org-keyword">name</span>, location) <span class="org-keyword">values</span> (<span class="org-string">'Rio bravo'</span>, point(100, 100));
</pre>
</div>

<pre class="example">
INSERT 0 1
</pre>


<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>Update operation</label><pre class="src src-sql"><span class="org-keyword">update</span> cities
  <span class="org-keyword">set</span> location = point(200, 200)
  <span class="org-keyword">where</span> <span class="org-keyword">name</span> = <span class="org-string">'Rio bravo'</span>
  returning *; <span class="org-comment">-- returns updated rows</span>
</pre>
</div>

<pre class="example">
name	location
Rio bravo	(200,200)
UPDATE 1
</pre>


<div class="org-src-container">
<pre class="src src-sql" id="org92f49ab"><span class="org-keyword">delete</span> <span class="org-keyword">from</span> cities
<span class="org-keyword">where</span> <span class="org-keyword">name</span> ilike <span class="org-string">'Rio Bravo'</span>; <span class="org-comment">-- case insensitive</span>
</pre>
</div>

<p>
#+RESULTS
</p>
<pre class="example">
DELETE 2
</pre>


<div class="org-src-container">
<pre class="src src-sql" id="org02622da"><span class="org-keyword">select</span> * <span class="org-keyword">from</span> cities;
</pre>
</div>

<pre class="example">
name	location
reynosa	(129,120)
monterrey	(102,30)
Rio bravo	(200,200)
</pre>


<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>transaction syntax example</label><pre class="src src-sql"><span class="org-keyword">BEGIN</span>;
<span class="org-keyword">UPDATE</span> accounts <span class="org-keyword">SET</span> balance = balance - 100.00
 <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = <span class="org-string">'Alice'</span>;
<span class="org-comment">-- etc etc</span>
<span class="org-keyword">COMMIT</span>;
<span class="org-comment">-- If, partway through the transaction, we decide we do not want to commit (perhaps we just noticed that</span>
<span class="org-comment">-- Alice's balance went negative), we can issue the command ROLLBACK instead of COMMIT, and all our</span>
<span class="org-comment">-- updates so far will be canceled.</span>





<span class="org-comment">-- It's possible to control the statements in a transaction in a more granular fashion through the use of save-</span>
<span class="org-comment">-- points. Savepoints allow you to selectively discard parts of the transaction, while committing the rest. After</span>
<span class="org-comment">-- defining a savepoint with SAVEPOINT, you can if needed roll back to the savepoint with ROLLBACK TO.</span>
<span class="org-comment">-- All the transaction's database changes between defining the savepoint and rolling back to it are discarded,</span>
<span class="org-comment">-- but changes earlier than the savepoint are kept.</span>
<span class="org-comment">-- Remembering the bank database, suppose we debit $100.00 from Alice's account, and credit Bob's account,</span>
<span class="org-comment">-- only to find later that we should have credited Wally's account. We could do it using savepoints like this:</span>
<span class="org-keyword">BEGIN</span>;
<span class="org-keyword">UPDATE</span> accounts <span class="org-keyword">SET</span> balance = balance - 100.00
 <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = <span class="org-string">'Alice'</span>;
<span class="org-keyword">SAVEPOINT</span> my_savepoint;
<span class="org-keyword">UPDATE</span> accounts <span class="org-keyword">SET</span> balance = balance + 100.00
 <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = <span class="org-string">'Bob'</span>;
<span class="org-comment">-- oops ... forget that and use Wally's account</span>
<span class="org-keyword">ROLLBACK</span> <span class="org-keyword">TO</span> my_savepoint;
<span class="org-keyword">UPDATE</span> accounts <span class="org-keyword">SET</span> balance = balance + 100.00
 <span class="org-keyword">WHERE</span> <span class="org-keyword">name</span> = <span class="org-string">'Wally'</span>;
<span class="org-keyword">COMMIT</span>;

</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>view creation and use of it example</label><pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">view</span> <span class="org-function-name">myView</span> <span class="org-keyword">as</span>
       <span class="org-keyword">select</span> * <span class="org-keyword">from</span> weather <span class="org-keyword">where</span> city = <span class="org-string">'reynosa'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> myView;
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>setting role and getting current<sub>role</sub></label><pre class="src src-sql"><span class="org-comment">-- default role in this session is 'postgres'</span>
<span class="org-keyword">create</span> <span class="org-keyword">role</span> role_x; <span class="org-comment">-- creating role with name role_x</span>
<span class="org-keyword">select</span> <span class="org-builtin">current_role</span>; <span class="org-comment">-- this outputs 'postgres'</span>
<span class="org-keyword">set</span> <span class="org-keyword">role</span> role_x; <span class="org-comment">-- set role x as the current role</span>
<span class="org-keyword">select</span> <span class="org-builtin">current_role</span>; <span class="org-comment">-- outputs 'role_x'</span>
</pre>
</div>

<pre class="example">
CREATE ROLE
current_role
postgres
SET
current_role
role_x
</pre>


<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>creating a function</label><pre class="src src-sql"><span class="org-comment">-- this below function just returns a text </span>
<span class="org-keyword">create</span> <span class="org-keyword">or</span> replace <span class="org-keyword">function</span> <span class="org-keyword">public</span>.some_function()
 <span class="org-keyword">returns</span> text
    <span class="org-keyword">language</span> plpgsql
<span class="org-keyword">as</span> $$
    <span class="org-keyword">begin</span>
        <span class="org-keyword">return</span> <span class="org-string">'Hello World'</span>;
    <span class="org-keyword">end</span>;
$$;


<span class="org-comment">-- executing the function</span>
<span class="org-keyword">select</span> some_function(); <span class="org-comment">-- this returns 'Hello World'</span>
</pre>
</div>

<pre class="example">
CREATE FUNCTION
some_function
Hello World
</pre>



<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- Now lets restrict the execution of 'some_function' function to an specific roke</span>
<span class="org-comment">-- in this case, we will prevent 'role_x' to execute 'some_function' function.</span>

<span class="org-comment">-- let's change the role</span>
<span class="org-keyword">set</span> <span class="org-keyword">role</span> role_x;

<span class="org-comment">-- now let's execute the function</span>
<span class="org-keyword">select</span> some_function(); <span class="org-comment">-- this will output 'Hello World'</span>

<span class="org-comment">-- let's revoke the permission of execution to role x</span>
<span class="org-comment">-- to achieve this, first let's change the role to a role that</span>
<span class="org-comment">-- has enough permissions to do this, like a superuser role, like 'postgres'</span>
<span class="org-comment">-- which is the default role in PostgreSQL</span>
<span class="org-comment">-- @Note: postgres role is a superuser role created by default during the</span>
<span class="org-comment">-- installation of PostgreSQL. The postgres role has full privileges over</span>
<span class="org-comment">-- the entire database system and can perform any operation, including granting</span>
<span class="org-comment">-- and revoking privileges for other roles. It's similar to the root user in a Unix system.</span>
<span class="org-keyword">set</span> <span class="org-keyword">role</span> postgres;
<span class="org-keyword">revoke</span> <span class="org-keyword">execute</span> <span class="org-keyword">on</span> <span class="org-keyword">function</span> some_function() <span class="org-keyword">from</span> role_x;

<span class="org-comment">-- lets verify trying to execute the function from role_x</span>
<span class="org-keyword">set</span> <span class="org-keyword">role</span> role_x;
<span class="org-keyword">select</span> some_function(); <span class="org-comment">-- this still not prevents the execution because this role inherits from 'public' role</span>
<span class="org-comment">-- so let's revoke really the function.</span>
<span class="org-keyword">set</span> <span class="org-keyword">role</span> postgres;
<span class="org-keyword">revoke</span> <span class="org-keyword">execute</span> <span class="org-keyword">on</span> <span class="org-keyword">function</span> some_function() <span class="org-keyword">from</span> <span class="org-keyword">public</span>;
<span class="org-keyword">set</span> <span class="org-keyword">role</span> role_x;

DO $$
<span class="org-keyword">DECLARE</span>
  <span class="org-keyword">result</span> text;
<span class="org-keyword">BEGIN</span>
    <span class="org-keyword">BEGIN</span>
        <span class="org-keyword">result</span> := <span class="org-keyword">select</span> some_function();
        RAISE NOTICE <span class="org-string">'Function returned: %'</span>, <span class="org-keyword">result</span>;
    <span class="org-keyword">EXCEPTION</span> <span class="org-keyword">WHEN</span> INSUFFICIENT_PRIVILEGE <span class="org-keyword">THEN</span>
        RAISE WARNING <span class="org-string">'An error occurred: %'</span>, SQLERRM;
    <span class="org-keyword">END</span>;
<span class="org-keyword">END</span>;
$$ <span class="org-keyword">LANGUAGE</span> plpgsql;

</pre>
</div>

<pre class="example">
SET
</pre>
</div>
</section>


<section id="outline-container-orgcc9ec4a" class="outline-2">
<h2 id="orgcc9ec4a"><span class="section-number-2">11</span> Course notes</h2>
<div class="outline-text-2" id="text-11">
<ul class="org-ul">
<li><a href="https://www.postgresql.org/docs/9.5/functions-math.html">Math operators in SQL</a></li>
</ul>
</div>


<div id="outline-container-org7137e0c" class="outline-3">
<h3 id="org7137e0c"><span class="section-number-3">11.1</span> Migrations</h3>
<div class="outline-text-3" id="text-11-1">
<p>
Big Lessons:
</p>
<ol class="org-ol">
<li>Changes to the DB structure and changes to clients need to be made at precisely the same time.</li>
<li>When working with other engineers, we need a really easy way to tie the structure of our database to our code.</li>
</ol>
</div>
</div>

<div id="outline-container-org7f02386" class="outline-3">
<h3 id="org7f02386"><span class="section-number-3">11.2</span> Foreign keys</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">
<pre class="src src-sql">
</pre>
</div>
</div>
</div>
</section>


<section id="outline-container-org31f5bdb" class="outline-2">
<h2 id="org31f5bdb"><span class="section-number-2">12</span> Random notes</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li><a href="https://medium.com/miro-engineering/sql-migrations-in-postgresql-part-1-bc38ec1cbe75">some common operations in postgresql migrations</a></li>
<li><a href="https://stackoverflow.com/questions/38388423/what-does-on-delete-do-on-django-models">Good not about on delete actions on a django/sql</a></li>
<li><a href="https://www.skypack.dev/view/graphile-worker-rewired">https://www.skypack.dev/view/graphile-worker-rewired</a></li>
</ul>




<p>
esto creo que es lo que usariamos para subir a s3.
<a href="https://github.com/graphile-contrib/postgraphile-plugin-derived-field">https://github.com/graphile-contrib/postgraphile-plugin-derived-field</a>
</p>
</div>
</section>
</nil>
<footer id="postamble" class="status">

<div class='footer'>
Copyright © 2022 <a href='mailto:aang.drummer@gmail.com'>Abel Güitian</a> | <a href='https://github.com/aang7/aang7.github.io'>Source</a><br>
Last updated on Aug 02, 2023 using Emacs 28.2 (Org mode 9.5.5) <br>
</div>
</footer>
</body>
</html>
